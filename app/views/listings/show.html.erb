<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAG4tWx7kUqZymglhMc6mRstD_RXXTEeMY"></script>

<div class="container-fluid">
  <div class="container">
    <div class="row">
      <div class="col-lg-3 mt-3">
         <h1><%= @listing.title %></h1>
         <span class="badge badge-pill mb-2"><%= @listing.category %> </span> <br />
            <% if is_listing_owner %>
               <%= link_to "Edit", edit_listing_path(@listing), class: 'btn btn-outline-info'%>
            <% end %>
            <%if not_listing_owner%>
               <%= link_to "Request Item", create_borrow_request_path(@listing), class: 'btn btn-outline-info mt-2'%>
            <%end%>
            <h5 class="mt-3"> Owner: </h5>  
            <%if @listing.user.person.image.attachment != nil and @listing.user.person.image.content_type.in?(%('image/jpeg image/png')) %>
              <%= image_tag(@listing.user.thumbnail, :class => "img-thumbnail rounded-circle")%>
            <% else %>
              <%= image_tag("empty-user-icon.png", :class => "user-icon rounded") %>
            <%end%>
            <h5 class="mt-3"> <%= @listing.user.name %> </h5>
				    <%= button_to "View Profile", user_path(@listing.user), class:"btn btn-primary", :method => :get %>
            <%= button_to "Send Message", user_path(@listing.user), class:"btn btn-primary", :method => :get %>
            <div id='user-lat' style="display: none"><%if @listing %><%= @listing.latitude%><%else%><%="N/A"%><%end%></div>
            <div id='user-long' style="display: none"><%if @listing %><%= @listing.longitude%><%else%><%="N/A"%><%end%></div>
            <%if @listing.latitude and @listing.longitude and @listing.address %> <!-- If listing location is valid-->
              <br><p class="card-text"> Meetup Location:<br><%= @listing.address %></p>
              <div id="user_map"></div>
            <% end %>
      </div>
      <div class="col-lg-9 mb-5">
        <div class="card mt-4">
                  
    <div id="carouselExampleFade" data-interval="2000" class="carousel slide" data-ride="carousel">
      <div class="carousel-inner">
        <% (0...@listing.images.count).each.with_index do |image, index| %>
            <% if index == 0 %>
              <div class="carousel-item active">
                <%= image_tag(@listing.thumbnail(image), :class => " d-block w-100 card-img-top", :style=>"object-fit:contain;")%>
              </div>
            <% else %>
              <div class="carousel-item">
                <%= image_tag(@listing.thumbnail(image), :class => " d-block w-100 card-img-top", :style=>"object-fit:contain;")%>
              </div>
            <%end%>
          <% end %>
      </div>
      <% if @listing.images.count > 1%>
        <a class="carousel-control-prev" href="#carouselExampleFade" role="button" data-slide="prev">
          <span class="carousel-control-prev-icon" aria-hidden="true"></span>
          <span class="sr-only">Previous</span>
        </a>
        <a class="carousel-control-next" href="#carouselExampleFade" role="button" data-slide="next">
          <span class="carousel-control-next-icon" aria-hidden="true"></span>
          <span class="sr-only">Next</span>
        </a>
      <% end %>
    </div>

            <div class="card-body pb-3">
              <h3 class="card-title"><%= @listing.title %></h3>
              <p class="card-text"><%= @listing.description %></p>
              <p class="card-text"> Average Rating:</p>
              <p class="card-text">
                <!-- I know this isn't the cleanest looking erb code.. but it works -->
                <% if get_rounded_rating == 0 %>
                    <p class="card-text"> No ratings yet </p>
                <% else %>
                  <% for i in 1..get_rounded_rating do %>
                    <i class="material-icons">
                    grade
                    </i>
                  <%end%>
                <% end %>
              </p>
            </div>
        </div>
        <!--  For adding a review -->
        <div class="card mt-2">
          <div class="card-header">Review this Item:</div>
          <div class="card text p-3">
           <%= form_for [@listing, Comment.new], class:"form-control" do |f| %>
                <%= f.text_area :body, placeholder: "Add a comment", class:'form-group' %><br/>
                <%= f.number_field :rating, placeholder: "Add rating" %><br/>
                <%= f.submit "Add Comment", class:'btn btn-outline-info mt-2' %>
              <% end %>
          </div>
        </div>
        <!-- Showing existing comments on the post  -->
        <%= render(partial: 'comments/comment', collection: @listing.comments) %>
      </div>
     </div>

   </div>
</div>

<style>
  #user_map {
    width: 100%;
    height: 200px;
  }
</style>

<script>

  var latitude = document.getElementById("user-lat").innerHTML;
  var longitude = document.getElementById("user-long").innerHTML;

  if (latitude == "N/A" || longitude == "N/A")
  {
    alert("Refresh the page to update your location again!");
  }
  else
  {
    var map = new GMaps({
      div: '#user_map',
      lat: latitude,
      lng: longitude
    });

    map.addMarker({
        lat: latitude,
        lng: longitude,
        title: 'My Location',
        click: function(e) {
          alert('My location is at [' + latitude + ', '+longitude+']');
        }
    }); 
  }
  
</script>